#include <stdbool.h>
#include <stdint.h>
#include "inc/hw_memmap.h"
#include "driverlib/gpio.h"
#include "driverlib/rom.h"
#include "driverlib/sysctl.h"
#include "driverlib/pin_map.h"
#include "ff.h"
#include "diskio.h"

#define SPI_LED_BASE GPIO_PORTF_BASE
#define SPI_LED_SYSCTL SYSCTL_PERIPH_GPIOF
#define SPI_LED_BUSY GPIO_PIN_0
#define SPI_LED_ERROR GPIO_PIN_4
#define COCO_CS_SYSCTL SYSCTL_PERIPH_GPIOC
#define COCO_CS_BASE GPIO_PORTC_BASE
#define COCO_CS GPIO_PIN_6

const uint16_t f88[] = {
  0x0000, 0x0000, 0x0000, 0x0000, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x003e, 0x222a, 0x2a22, 0x3e00, //
  0x0000, 0x0000, 0x0000, 0x0000, // space
  0x0808, 0x0808, 0x0800, 0x0800, // !
  0x1414, 0x1400, 0x0000, 0x0000, // "
  0x1414, 0x3600, 0x3614, 0x1400, // #
  0x081e, 0x201c, 0x023c, 0x0800, // $
  0x3232, 0x0408, 0x1026, 0x2600, // %
  0x1028, 0x2810, 0x2a24, 0x1a00, // &
  0x1818, 0x1800, 0x0000, 0x0000, // '
  0x0810, 0x2020, 0x2010, 0x0800, // (
  0x0804, 0x0202, 0x0204, 0x0800, // )
  0x0008, 0x1c3e, 0x1c08, 0x0000, // *
  0x0008, 0x083e, 0x0808, 0x0000, // +
  0x0000, 0x0030, 0x3010, 0x2000, // ,
  0x0000, 0x003e, 0x0000, 0x0000, // -
  0x0000, 0x0000, 0x0030, 0x3000, // .
  0x0202, 0x0408, 0x1020, 0x2000, // /
  0x1824, 0x2424, 0x2424, 0x1800, // 0
  0x0818, 0x0808, 0x0808, 0x1c00, // 1
  0x1c22, 0x021c, 0x2020, 0x3e00, // 2
  0x1c22, 0x020c, 0x0222, 0x1c00, // 3
  0x040c, 0x143e, 0x0404, 0x0400, // 4
  0x3e20, 0x3c02, 0x0222, 0x1c00, // 5
  0x1c20, 0x203c, 0x2222, 0x1c00, // 6
  0x3e02, 0x0408, 0x1020, 0x2000, // 7
  0x1c22, 0x221c, 0x2222, 0x1c00, // 8
  0x1c22, 0x221e, 0x0202, 0x1c00, // 9
  0x0018, 0x1800, 0x1818, 0x0000, // :
  0x1818, 0x0018, 0x1808, 0x1000, // ;
  0x0408, 0x1020, 0x1008, 0x0400, // <
  0x0000, 0x3e00, 0x3e00, 0x0000, // =
  0x2010, 0x0804, 0x0810, 0x2000, // >
  0x1824, 0x0408, 0x0800, 0x0800, // ?
  0x3c22, 0x021a, 0x2a2a, 0x1c00, // @
  0x0814, 0x2222, 0x3e22, 0x2200, // A  
  0x3c12, 0x121c, 0x1212, 0x3c00, // B
  0x1c22, 0x2020, 0x2022, 0x1c00, // C
  0x3c12, 0x1212, 0x1212, 0x3c00, // D
  0x3e20, 0x203c, 0x2020, 0x3e00, // E
  0x3e20, 0x203c, 0x2020, 0x2000, // F
  0x1e20, 0x2026, 0x2222, 0x1e00, // G
  0x2222, 0x223e, 0x2222, 0x2200, // H
  0x1c08, 0x0808, 0x0808, 0x1c00, // I
  0x0202, 0x0202, 0x2222, 0x1c00, // J
  0x2224, 0x2830, 0x2824, 0x2200, // K
  0x2020, 0x2020, 0x2020, 0x3e00, // L
  0x2236, 0x2a2a, 0x2222, 0x2200, // M
  0x2232, 0x2a26, 0x2222, 0x2200, // N
  0x3e22, 0x2222, 0x2222, 0x3e00, // O
  0x3c22, 0x223c, 0x2020, 0x2000, // P
  0x1c22, 0x2222, 0x2a24, 0x1a00, // Q
  0x3c22, 0x223c, 0x2824, 0x2200, // R
  0x1c22, 0x1008, 0x0422, 0x1c00, // S
  0x3e08, 0x0808, 0x0808, 0x0800, // T
  0x2222, 0x2222, 0x2222, 0x1c00, // U
  0x2222, 0x2214, 0x1408, 0x0800, // V
  0x2222, 0x222a, 0x2a36, 0x2200, // W
  0x2222, 0x1408, 0x1422, 0x2200, // X
  0x2222, 0x1408, 0x0808, 0x0800, // Y
  0x3e02, 0x0408, 0x1020, 0x3e00, // Z
  0x3820, 0x2020, 0x2020, 0x3800, // [
  0x2020, 0x1008, 0x0402, 0x0200, // backslash
  0x0e02, 0x0202, 0x0202, 0x0e00, // ]
  0x081c, 0x2a08, 0x0808, 0x0800, // up
  0x0008, 0x103e, 0x1008, 0x0000, // left
  0x3018, 0x0c00, 0x0000, 0x0000, // `
  0x0000, 0x1c02, 0x1e22, 0x1e00, // a
  0x2020, 0x3c22, 0x2222, 0x3c00, // b
  0x0000, 0x1c22, 0x2022, 0x1c00, // c
  0x0202, 0x1e22, 0x2222, 0x1e00, // d
  0x0000, 0x1c22, 0x3c20, 0x1e00, // e
  0x0c12, 0x103c, 0x1010, 0x1000, // f
  0x0000, 0x1c22, 0x221e, 0x023c, // g
  0x2020, 0x2c32, 0x2222, 0x2200, // h
  0x0800, 0x1808, 0x0808, 0x1c00, // i
  0x0400, 0x0c04, 0x0404, 0x2418, // j
  0x2020, 0x2224, 0x2824, 0x2200, // k
  0x1808, 0x0808, 0x0808, 0x1c00, // l
  0x0000, 0x342a, 0x2a2a, 0x2200, // m
  0x0000, 0x2c32, 0x2222, 0x2200, // n
  0x0000, 0x1c22, 0x2222, 0x1c00, // o
  0x0000, 0x3c22, 0x223c, 0x2020, // p
  0x0000, 0x1e22, 0x221e, 0x0202, // q
  0x0000, 0x2c32, 0x2020, 0x2000, // r
  0x0000, 0x1e20, 0x1c02, 0x3c00, // s
  0x1010, 0x3c10, 0x1012, 0x0c00, // t
  0x0000, 0x2222, 0x2226, 0x1a00, // u
  0x0000, 0x2222, 0x1414, 0x0800, // v
  0x0000, 0x222a, 0x2a2a, 0x1400, // w
  0x0000, 0x2214, 0x0814, 0x2200, // x
  0x0000, 0x2222, 0x261a, 0x023c, // y
  0x0000, 0x3e04, 0x0810, 0x3e00, // z
  0x0c10, 0x1020, 0x1010, 0x0c00, // {
  0x0808, 0x0800, 0x0808, 0x0800, // |
  0x3008, 0x0804, 0x0808, 0x3000, // }
  0x122a, 0x2400, 0x0000, 0x0000, // ~
  0x1c26, 0x3a36, 0x3e36, 0x1c00 // del
};

void setAddr(uint32_t address) {
  ROM_GPIOPinWrite(COCO_CS_BASE, COCO_CS, 0);
  ROM_SSIDataPut(SDC_SSI_BASE, 0x01);
  ROM_SSIDataPut(SDC_SSI_BASE, (address >> 16));
  ROM_SSIDataPut(SDC_SSI_BASE, (address >> 8));
  ROM_SSIDataPut(SDC_SSI_BASE, address);
  ROM_GPIOPinWrite(COCO_CS_BASE, COCO_CS, COCO_CS);
}

void setData(uint16_t data) {
  ROM_GPIOPinWrite(COCO_CS_BASE, COCO_CS, 0);
  ROM_SSIDataPut(SDC_SSI_BASE, 0x03);
  ROM_SSIDataPut(SDC_SSI_BASE, (data >> 8));
  ROM_SSIDataPut(SDC_SSI_BASE, data);
  ROM_GPIOPinWrite(COCO_CS_BASE, COCO_CS, COCO_CS);
}

FATFS fatfs_obj;
DIR dir_obj;
FIL fil_obj;
FILINFO fno;

int main() {
  FRESULT res;

  ROM_SysCtlPeripheralEnable(SPI_LED_SYSCTL);
  ROM_GPIOPinTypeGPIOOutput(SPI_LED_BASE, SPI_LED_ERROR|SPI_LED_BUSY);

  SysCtlClockSet(SYSCTL_SYSDIV_1 | SYSCTL_USE_OSC | SYSCTL_OSC_MAIN | SYSCTL_XTAL_16MHZ);

  disk_initialize(0);
  ROM_SysCtlPeripheralEnable(COCO_CS_SYSCTL);
  ROM_GPIOPinTypeGPIOOutput(COCO_CS_BASE, COCO_CS);
  ROM_GPIOPinWrite(COCO_CS_BASE, COCO_CS, COCO_CS);

/*  if ((res = f_mount(0, &fatfs_obj))) {
    ROM_GPIOPinWrite(SPI_LED_BASE, SPI_LED_ERROR|SPI_LED_BUSY, SPI_LED_ERROR);
    while (1);
  }

  if ((res = f_opendir(&dir_obj, (const TCHAR *)"/"))) {
    ROM_GPIOPinWrite(SPI_LED_BASE, SPI_LED_ERROR|SPI_LED_BUSY, SPI_LED_BUSY);
    while (1);
  } */
  
  setAddr(0x413000);
  for (int i=0; i < 4*128; i++)
    setData(f88[i]);

  uint16_t foo;

  setAddr(0x420000);
  foo=0x20;  
  while (foo < 0x80) {
    setData((foo << 8) | (foo+1));
    foo = foo + 2;
    //    ROM_SysCtlDelay(100000);
  }

  while (1);
}
